"""add_assets_table

Revision ID: ddc2fb76e0fb
Revises: create_incident_tables
Create Date: 2025-12-26 20:36:50.229172

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy import inspect, text


# revision identifiers, used by Alembic.
revision: str = 'ddc2fb76e0fb'
down_revision: Union[str, None] = 'create_incident_tables'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    
    # Check if assets table already exists
    conn = op.get_bind()
    inspector = inspect(conn)
    existing_tables = inspector.get_table_names()
    
    # Clean up any leftover temporary tables from previous failed migrations
    temp_tables = [t for t in existing_tables if t.startswith('_alembic_tmp_')]
    for temp_table in temp_tables:
        try:
            op.execute(f"DROP TABLE IF EXISTS {temp_table}")
        except Exception:
            pass  # Table might be locked or already dropped
    
    # Helper function to safely drop index if it exists
    def safe_drop_index(batch_op, table_name, index_name):
        """Safely drop an index if it exists"""
        try:
            table_indexes = [idx['name'] for idx in inspector.get_indexes(table_name)]
            if index_name in table_indexes:
                batch_op.drop_index(batch_op.f(index_name))
        except Exception:
            pass  # Index doesn't exist or table doesn't exist, skip
    
    # Only create assets table if it doesn't exist
    if 'assets' not in existing_tables:
        op.create_table('assets',
            sa.Column('id', sa.Integer(), nullable=False),
            sa.Column('company_id', sa.Integer(), nullable=False),
            sa.Column('site_id', sa.Integer(), nullable=False),
            sa.Column('asset_name', sa.String(length=255), nullable=False),
            sa.Column('quantity', sa.Integer(), nullable=False),
            sa.Column('category', sa.String(length=100), nullable=True),
            sa.Column('condition', sa.String(length=50), nullable=True),
            sa.Column('detail', sa.Text(), nullable=True),
            sa.Column('remark', sa.Text(), nullable=True),
            sa.Column('created_at', sa.DateTime(), nullable=False),
            sa.Column('updated_at', sa.DateTime(), nullable=False),
            sa.Column('created_by', sa.Integer(), nullable=True),
            sa.Column('updated_by', sa.Integer(), nullable=True),
            sa.ForeignKeyConstraint(['created_by'], ['users.id'], ),
            sa.ForeignKeyConstraint(['site_id'], ['sites.id'], ),
            sa.ForeignKeyConstraint(['updated_by'], ['users.id'], ),
            sa.PrimaryKeyConstraint('id')
        )
        with op.batch_alter_table('assets', schema=None) as batch_op:
            batch_op.create_index(batch_op.f('ix_assets_asset_name'), ['asset_name'], unique=False)
            batch_op.create_index(batch_op.f('ix_assets_category'), ['category'], unique=False)
            batch_op.create_index(batch_op.f('ix_assets_company_id'), ['company_id'], unique=False)
            batch_op.create_index(batch_op.f('ix_assets_condition'), ['condition'], unique=False)
            batch_op.create_index(batch_op.f('ix_assets_id'), ['id'], unique=False)
            batch_op.create_index(batch_op.f('ix_assets_site_id'), ['site_id'], unique=False)
    else:
        # Table exists, but ensure indexes exist
        try:
            existing_indexes = [idx['name'] for idx in inspector.get_indexes('assets')]
            index_mappings = {
                'ix_assets_asset_name': 'asset_name',
                'ix_assets_category': 'category',
                'ix_assets_company_id': 'company_id',
                'ix_assets_condition': 'condition',
                'ix_assets_id': 'id',
                'ix_assets_site_id': 'site_id'
            }
            for idx_name, col_name in index_mappings.items():
                if idx_name not in existing_indexes:
                    try:
                        op.create_index(op.f(idx_name), 'assets', [col_name], unique=False)
                    except Exception:
                        pass
        except Exception:
            pass  # If we can't check/create indexes, continue

    # Drop findings_reports table and its indexes (safely)
    existing_tables_after = inspector.get_table_names()
    if 'findings_reports' in existing_tables_after:
        with op.batch_alter_table('findings_reports', schema=None) as batch_op:
            safe_drop_index(batch_op, 'findings_reports', 'ix_findings_reports_company_id')
            safe_drop_index(batch_op, 'findings_reports', 'ix_findings_reports_id')
        op.drop_table('findings_reports')
    if 'audit_executions' in existing_tables_after:
        with op.batch_alter_table('audit_executions', schema=None) as batch_op:
            safe_drop_index(batch_op, 'audit_executions', 'ix_audit_executions_audit_schedule_id')
            safe_drop_index(batch_op, 'audit_executions', 'ix_audit_executions_id')
        op.drop_table('audit_executions')
    if 'stplk_reports' in existing_tables_after:
        with op.batch_alter_table('stplk_reports', schema=None) as batch_op:
            safe_drop_index(batch_op, 'stplk_reports', 'ix_stplk_reports_company_id')
            safe_drop_index(batch_op, 'stplk_reports', 'ix_stplk_reports_id')
        op.drop_table('stplk_reports')
    if 'patrol_logs' in existing_tables_after:
        with op.batch_alter_table('patrol_logs', schema=None) as batch_op:
            safe_drop_index(batch_op, 'patrol_logs', 'ix_patrol_logs_assignment_id')
            safe_drop_index(batch_op, 'patrol_logs', 'ix_patrol_logs_id')
        op.drop_table('patrol_logs')
    if 'compliance_checklists' in existing_tables_after:
        with op.batch_alter_table('compliance_checklists', schema=None) as batch_op:
            safe_drop_index(batch_op, 'compliance_checklists', 'ix_compliance_checklists_company_id')
            safe_drop_index(batch_op, 'compliance_checklists', 'ix_compliance_checklists_id')
            safe_drop_index(batch_op, 'compliance_checklists', 'ix_compliance_checklists_site_id')
        op.drop_table('compliance_checklists')
    if 'audit_schedules' in existing_tables_after:
        with op.batch_alter_table('audit_schedules', schema=None) as batch_op:
            safe_drop_index(batch_op, 'audit_schedules', 'ix_audit_schedules_company_id')
            safe_drop_index(batch_op, 'audit_schedules', 'ix_audit_schedules_id')
            safe_drop_index(batch_op, 'audit_schedules', 'ix_audit_schedules_scheduled_date')
            safe_drop_index(batch_op, 'audit_schedules', 'ix_audit_schedules_site_id')
            safe_drop_index(batch_op, 'audit_schedules', 'ix_audit_schedules_status')
        op.drop_table('audit_schedules')
    if 'patrol_schedules' in existing_tables_after:
        with op.batch_alter_table('patrol_schedules', schema=None) as batch_op:
            safe_drop_index(batch_op, 'patrol_schedules', 'ix_patrol_schedules_company_id')
            safe_drop_index(batch_op, 'patrol_schedules', 'ix_patrol_schedules_id')
            safe_drop_index(batch_op, 'patrol_schedules', 'ix_patrol_schedules_scheduled_date')
            safe_drop_index(batch_op, 'patrol_schedules', 'ix_patrol_schedules_site_id')
        op.drop_table('patrol_schedules')
    if 'patrol_assignments' in existing_tables_after:
        with op.batch_alter_table('patrol_assignments', schema=None) as batch_op:
            safe_drop_index(batch_op, 'patrol_assignments', 'ix_patrol_assignments_id')
            safe_drop_index(batch_op, 'patrol_assignments', 'ix_patrol_assignments_schedule_id')
            safe_drop_index(batch_op, 'patrol_assignments', 'ix_patrol_assignments_status')
            safe_drop_index(batch_op, 'patrol_assignments', 'ix_patrol_assignments_user_id')
        op.drop_table('patrol_assignments')
    if 'lk_lp_reports' in existing_tables_after:
        with op.batch_alter_table('lk_lp_reports', schema=None) as batch_op:
            safe_drop_index(batch_op, 'lk_lp_reports', 'ix_lk_lp_reports_company_id')
            safe_drop_index(batch_op, 'lk_lp_reports', 'ix_lk_lp_reports_id')
            safe_drop_index(batch_op, 'lk_lp_reports', 'ix_lk_lp_reports_incident_date')
            safe_drop_index(batch_op, 'lk_lp_reports', 'ix_lk_lp_reports_incident_type')
            safe_drop_index(batch_op, 'lk_lp_reports', 'ix_lk_lp_reports_site_id')
            safe_drop_index(batch_op, 'lk_lp_reports', 'ix_lk_lp_reports_status')
        op.drop_table('lk_lp_reports')
    if 'patrol_reports' in existing_tables_after:
        with op.batch_alter_table('patrol_reports', schema=None) as batch_op:
            safe_drop_index(batch_op, 'patrol_reports', 'ix_patrol_reports_assignment_id')
            safe_drop_index(batch_op, 'patrol_reports', 'ix_patrol_reports_id')
            safe_drop_index(batch_op, 'patrol_reports', 'ix_patrol_reports_report_date')
        op.drop_table('patrol_reports')
    if 'bap_reports' in existing_tables_after:
        with op.batch_alter_table('bap_reports', schema=None) as batch_op:
            safe_drop_index(batch_op, 'bap_reports', 'ix_bap_reports_company_id')
            safe_drop_index(batch_op, 'bap_reports', 'ix_bap_reports_id')
            safe_drop_index(batch_op, 'bap_reports', 'ix_bap_reports_site_id')
        op.drop_table('bap_reports')
    with op.batch_alter_table('attendance', schema=None) as batch_op:
        batch_op.alter_column('is_overtime',
               existing_type=sa.INTEGER(),
               type_=sa.Boolean(),
               nullable=False,
               existing_server_default=sa.text('0'))
        batch_op.alter_column('is_backup',
               existing_type=sa.INTEGER(),
               type_=sa.Boolean(),
               nullable=False,
               existing_server_default=sa.text('0'))

    with op.batch_alter_table('audit_logs', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('user_id',
               existing_type=sa.INTEGER(),
               nullable=False)
        batch_op.alter_column('user_agent',
               existing_type=sa.TEXT(),
               type_=sa.String(length=512),
               existing_nullable=True)
        safe_drop_index(batch_op, 'audit_logs', 'idx_audit_logs_action')
        safe_drop_index(batch_op, 'audit_logs', 'idx_audit_logs_company_id')
        safe_drop_index(batch_op, 'audit_logs', 'idx_audit_logs_created_at')
        safe_drop_index(batch_op, 'audit_logs', 'idx_audit_logs_resource_id')
        safe_drop_index(batch_op, 'audit_logs', 'idx_audit_logs_resource_type')
        safe_drop_index(batch_op, 'audit_logs', 'idx_audit_logs_user_id')
        batch_op.create_index(batch_op.f('ix_audit_logs_action'), ['action'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_logs_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_logs_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_logs_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_logs_resource_id'), ['resource_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_logs_resource_type'), ['resource_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_logs_user_id'), ['user_id'], unique=False)

    with op.batch_alter_table('cctv_cameras', schema=None) as batch_op:
        # Check if zone_name column already exists
        try:
            cctv_columns = [col['name'] for col in inspector.get_columns('cctv_cameras')]
            if 'zone_name' not in cctv_columns:
                batch_op.add_column(sa.Column('zone_name', sa.String(length=255), nullable=True))
        except Exception:
            # If we can't check, try to add it anyway (will fail gracefully if exists)
            try:
                batch_op.add_column(sa.Column('zone_name', sa.String(length=255), nullable=True))
            except Exception:
                pass  # Column might already exist
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        safe_drop_index(batch_op, 'cctv_cameras', 'idx_cctv_cameras_company_id')
        safe_drop_index(batch_op, 'cctv_cameras', 'idx_cctv_cameras_is_active')
        safe_drop_index(batch_op, 'cctv_cameras', 'idx_cctv_cameras_site_id')
        batch_op.create_index(batch_op.f('ix_cctv_cameras_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_cctv_cameras_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_cctv_cameras_site_id'), ['site_id'], unique=False)
        # Only create zone_name index if column exists
        try:
            cctv_columns_after = [col['name'] for col in inspector.get_columns('cctv_cameras')]
            if 'zone_name' in cctv_columns_after:
                existing_cctv_indexes = [idx['name'] for idx in inspector.get_indexes('cctv_cameras')]
                if 'ix_cctv_cameras_zone_name' not in existing_cctv_indexes:
                    batch_op.create_index(batch_op.f('ix_cctv_cameras_zone_name'), ['zone_name'], unique=False)
        except Exception:
            pass
        batch_op.drop_column('position_lng')
        batch_op.drop_column('description')
        batch_op.drop_column('position_lat')

    # First set default value for NULL mock_location before altering column
    # This must happen before batch_alter_table tries to copy data
    try:
        # Update NULL values to 0 (False) before making column NOT NULL
        op.execute("UPDATE checklist_items SET mock_location = 0 WHERE mock_location IS NULL")
    except Exception:
        # If update fails, continue - might be no rows or column doesn't exist
        pass
    
    with op.batch_alter_table('checklist_items', schema=None) as batch_op:
        batch_op.alter_column('mock_location',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               server_default=sa.text('0'))
        batch_op.create_index(batch_op.f('ix_checklist_items_kpi_key'), ['kpi_key'], unique=False)

    with op.batch_alter_table('checklist_template_items', schema=None) as batch_op:
        batch_op.alter_column('photo_required',
               existing_type=sa.BOOLEAN(),
               nullable=False,
               existing_server_default=sa.text('0'))
        batch_op.create_index(batch_op.f('ix_checklist_template_items_kpi_key'), ['kpi_key'], unique=False)

    with op.batch_alter_table('checklist_templates', schema=None) as batch_op:
        batch_op.alter_column('division',
               existing_type=sa.VARCHAR(length=32),
               nullable=False)

    # Set default value for NULL division before making it NOT NULL
    try:
        op.execute("UPDATE checklists SET division = 'SECURITY' WHERE division IS NULL")
    except Exception:
        pass  # If update fails, continue - might be no rows or column doesn't exist
    
    with op.batch_alter_table('checklists', schema=None) as batch_op:
        batch_op.alter_column('division',
               existing_type=sa.TEXT(),
               type_=sa.String(length=32),
               nullable=False)
        batch_op.create_index(batch_op.f('ix_checklists_context_id'), ['context_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_checklists_context_type'), ['context_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_checklists_division'), ['division'], unique=False)

    with op.batch_alter_table('cleaning_zones', schema=None) as batch_op:
        batch_op.alter_column('division',
               existing_type=sa.VARCHAR(length=32),
               nullable=False)
        batch_op.create_index(batch_op.f('ix_cleaning_zones_division'), ['division'], unique=False)

    with op.batch_alter_table('development_plans', schema=None) as batch_op:
        batch_op.add_column(sa.Column('completion_date', sa.Date(), nullable=True))
        batch_op.add_column(sa.Column('evaluation', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('evaluation_date', sa.Date(), nullable=True))
        batch_op.add_column(sa.Column('evaluated_by', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('notes', sa.Text(), nullable=True))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.drop_index(batch_op.f('idx_development_plans_company_id'))
        batch_op.drop_index(batch_op.f('idx_development_plans_status'))
        batch_op.drop_index(batch_op.f('idx_development_plans_user_id'))
        batch_op.create_index(batch_op.f('ix_development_plans_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_development_plans_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_development_plans_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_development_plans_target_date'), ['target_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_development_plans_user_id'), ['user_id'], unique=False)
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'users', ['evaluated_by'], ['id'])
        batch_op.drop_column('completed_at')
        batch_op.drop_column('progress_percentage')
        batch_op.drop_column('end_date')
        batch_op.drop_column('evaluation_notes')

    with op.batch_alter_table('document_versions', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.drop_index(batch_op.f('idx_document_versions_document_id'))
        batch_op.create_index(batch_op.f('ix_document_versions_document_id'), ['document_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_document_versions_id'), ['id'], unique=False)

    with op.batch_alter_table('documents', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('document_type',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.Enum('SOP', 'WORK_INSTRUCTION', 'POLICY', 'MANUAL', 'FORM', 'OTHER', name='documenttype'),
               existing_nullable=False)
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.Enum('DRAFT', 'UNDER_REVIEW', 'APPROVED', 'ACTIVE', 'ARCHIVED', 'OBSOLETE', name='documentstatus'),
               existing_nullable=False,
               existing_server_default=sa.text("'DRAFT'"))
        batch_op.drop_index(batch_op.f('idx_documents_category'))
        batch_op.drop_index(batch_op.f('idx_documents_company_id'))
        batch_op.drop_index(batch_op.f('idx_documents_division'))
        batch_op.drop_index(batch_op.f('idx_documents_document_number'))
        batch_op.drop_index(batch_op.f('idx_documents_document_type'))
        batch_op.drop_index(batch_op.f('idx_documents_effective_date'))
        batch_op.drop_index(batch_op.f('idx_documents_status'))
        batch_op.create_index(batch_op.f('ix_documents_category'), ['category'], unique=False)
        batch_op.create_index(batch_op.f('ix_documents_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_documents_division'), ['division'], unique=False)
        batch_op.create_index(batch_op.f('ix_documents_document_number'), ['document_number'], unique=True)
        batch_op.create_index(batch_op.f('ix_documents_document_type'), ['document_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_documents_effective_date'), ['effective_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_documents_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_documents_status'), ['status'], unique=False)

    with op.batch_alter_table('employee_contracts', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('contract_type',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.Enum('PERMANENT', 'CONTRACT', 'INTERNSHIP', 'PART_TIME', name='contracttype'),
               existing_nullable=False)
        batch_op.drop_index(batch_op.f('idx_employee_contracts_contract_number'))
        batch_op.drop_index(batch_op.f('idx_employee_contracts_employee_id'))
        batch_op.drop_index(batch_op.f('idx_employee_contracts_end_date'))
        batch_op.drop_index(batch_op.f('idx_employee_contracts_start_date'))
        batch_op.drop_index(batch_op.f('idx_employee_contracts_status'))
        batch_op.create_index(batch_op.f('ix_employee_contracts_contract_number'), ['contract_number'], unique=True)
        batch_op.create_index(batch_op.f('ix_employee_contracts_employee_id'), ['employee_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_employee_contracts_end_date'), ['end_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_employee_contracts_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_employee_contracts_start_date'), ['start_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_employee_contracts_status'), ['status'], unique=False)

    with op.batch_alter_table('employees', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.Enum('ACTIVE', 'INACTIVE', 'TERMINATED', 'ON_LEAVE', name='employeestatus'),
               existing_nullable=False,
               existing_server_default=sa.text("'ACTIVE'"))
        batch_op.drop_index(batch_op.f('idx_employees_company_id'))
        batch_op.drop_index(batch_op.f('idx_employees_email'))
        batch_op.drop_index(batch_op.f('idx_employees_employee_number'))
        batch_op.drop_index(batch_op.f('idx_employees_nik'))
        batch_op.drop_index(batch_op.f('idx_employees_site_id'))
        batch_op.drop_index(batch_op.f('idx_employees_status'))
        batch_op.drop_index(batch_op.f('idx_employees_user_id'))
        batch_op.create_index(batch_op.f('ix_employees_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_employees_email'), ['email'], unique=False)
        batch_op.create_index(batch_op.f('ix_employees_employee_number'), ['employee_number'], unique=True)
        batch_op.create_index(batch_op.f('ix_employees_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_employees_nik'), ['nik'], unique=True)
        batch_op.create_index(batch_op.f('ix_employees_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_employees_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_employees_user_id'), ['user_id'], unique=True)

    with op.batch_alter_table('gps_tracks', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('latitude',
               existing_type=sa.REAL(),
               type_=sa.Float(),
               existing_nullable=False,
               existing_server_default=sa.text('0'))
        batch_op.alter_column('longitude',
               existing_type=sa.REAL(),
               type_=sa.Float(),
               existing_nullable=False,
               existing_server_default=sa.text('0'))
        batch_op.alter_column('altitude',
               existing_type=sa.REAL(),
               type_=sa.Float(),
               existing_nullable=True)
        batch_op.alter_column('accuracy',
               existing_type=sa.REAL(),
               type_=sa.Float(),
               existing_nullable=True)
        batch_op.alter_column('speed',
               existing_type=sa.REAL(),
               type_=sa.Float(),
               existing_nullable=True)
        batch_op.drop_index(batch_op.f('idx_gps_tracks_company_id'))
        batch_op.drop_index(batch_op.f('idx_gps_tracks_patrol_log_id'))
        batch_op.drop_index(batch_op.f('idx_gps_tracks_recorded_at'))
        batch_op.drop_index(batch_op.f('idx_gps_tracks_site_id'))
        batch_op.drop_index(batch_op.f('idx_gps_tracks_start_time'))
        batch_op.drop_index(batch_op.f('idx_gps_tracks_track_reference_id'))
        batch_op.drop_index(batch_op.f('idx_gps_tracks_track_type'))
        batch_op.drop_index(batch_op.f('idx_gps_tracks_user_id'))
        batch_op.create_index(batch_op.f('ix_gps_tracks_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_gps_tracks_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_gps_tracks_recorded_at'), ['recorded_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_gps_tracks_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_gps_tracks_track_reference_id'), ['track_reference_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_gps_tracks_track_type'), ['track_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_gps_tracks_user_id'), ['user_id'], unique=False)
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        batch_op.drop_column('distance_km')
        batch_op.drop_column('start_time')
        batch_op.drop_column('duration_minutes')
        batch_op.drop_column('patrol_log_id')
        batch_op.drop_column('end_time')
        batch_op.drop_column('track_data')

    with op.batch_alter_table('leave_requests', schema=None) as batch_op:
        batch_op.alter_column('created_at',
               existing_type=sa.DATETIME(),
               nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=sa.DATETIME(),
               nullable=True)
        batch_op.create_index(batch_op.f('ix_leave_requests_created_at'), ['created_at'], unique=False)

    with op.batch_alter_table('master_data', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('code',
               existing_type=sa.VARCHAR(length=128),
               nullable=False)
        batch_op.alter_column('extra_data',
               existing_type=sa.TEXT(),
               type_=sa.JSON(),
               existing_nullable=True)
        batch_op.alter_column('sort_order',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
        batch_op.drop_index(batch_op.f('idx_master_data_category'))
        batch_op.drop_index(batch_op.f('idx_master_data_code'))
        batch_op.drop_index(batch_op.f('idx_master_data_company_id'))
        batch_op.drop_index(batch_op.f('idx_master_data_division'))
        batch_op.drop_index(batch_op.f('idx_master_data_is_active'))
        batch_op.drop_index(batch_op.f('idx_master_data_parent_id'))
        batch_op.create_index(batch_op.f('ix_master_data_category'), ['category'], unique=False)
        batch_op.create_index(batch_op.f('ix_master_data_code'), ['code'], unique=False)
        batch_op.create_index(batch_op.f('ix_master_data_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_master_data_division'), ['division'], unique=False)
        batch_op.create_index(batch_op.f('ix_master_data_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_master_data_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_master_data_parent_id'), ['parent_id'], unique=False)

    with op.batch_alter_table('patrol_targets', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('completion_percentage',
               existing_type=sa.REAL(),
               type_=sa.Float(),
               existing_nullable=False,
               existing_server_default=sa.text('(0.0)'))
        batch_op.drop_index(batch_op.f('idx_patrol_targets_company_id'))
        batch_op.drop_index(batch_op.f('idx_patrol_targets_route_id'))
        batch_op.drop_index(batch_op.f('idx_patrol_targets_site_id'))
        batch_op.drop_index(batch_op.f('idx_patrol_targets_status'))
        batch_op.drop_index(batch_op.f('idx_patrol_targets_target_date'))
        batch_op.drop_index(batch_op.f('idx_patrol_targets_zone_id'))
        batch_op.create_index(batch_op.f('ix_patrol_targets_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_targets_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_targets_route_id'), ['route_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_targets_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_targets_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_targets_target_date'), ['target_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_targets_zone_id'), ['zone_id'], unique=False)

    with op.batch_alter_table('patrol_teams', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('team_members',
               existing_type=sa.TEXT(),
               type_=sa.JSON(),
               existing_nullable=False)
        batch_op.alter_column('assigned_routes',
               existing_type=sa.TEXT(),
               type_=sa.JSON(),
               existing_nullable=True)
        batch_op.drop_index(batch_op.f('idx_patrol_teams_company_id'))
        batch_op.drop_index(batch_op.f('idx_patrol_teams_division'))
        batch_op.drop_index(batch_op.f('idx_patrol_teams_is_active'))
        batch_op.drop_index(batch_op.f('idx_patrol_teams_site_id'))
        batch_op.drop_index(batch_op.f('idx_patrol_teams_team_leader_id'))
        batch_op.create_index(batch_op.f('ix_patrol_teams_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_teams_division'), ['division'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_teams_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_teams_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_teams_site_id'), ['site_id'], unique=False)

    with op.batch_alter_table('payments', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('payment_method',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.Enum('BANK_TRANSFER', 'CASH', 'E_WALLET', 'PAYMENT_GATEWAY', name='paymentmethod'),
               existing_nullable=False)
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.Enum('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'CANCELLED', name='paymentstatus'),
               existing_nullable=False,
               existing_server_default=sa.text("'PENDING'"))
        batch_op.drop_index(batch_op.f('idx_payments_payroll_id'))
        batch_op.drop_index(batch_op.f('idx_payments_status'))
        batch_op.drop_index(batch_op.f('idx_payments_transaction_id'))
        batch_op.create_index(batch_op.f('ix_payments_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_payments_payroll_id'), ['payroll_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_payments_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_payments_transaction_id'), ['transaction_id'], unique=True)

    with op.batch_alter_table('payrolls', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.Enum('DRAFT', 'APPROVED', 'PAID', 'CANCELLED', name='payrollstatus'),
               existing_nullable=False,
               existing_server_default=sa.text("'DRAFT'"))
        batch_op.drop_index(batch_op.f('idx_payrolls_company_id'))
        batch_op.drop_index(batch_op.f('idx_payrolls_invoice_number'))
        batch_op.drop_index(batch_op.f('idx_payrolls_period_end'))
        batch_op.drop_index(batch_op.f('idx_payrolls_period_start'))
        batch_op.drop_index(batch_op.f('idx_payrolls_status'))
        batch_op.drop_index(batch_op.f('idx_payrolls_user_id'))
        batch_op.create_index(batch_op.f('ix_payrolls_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_payrolls_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_payrolls_invoice_number'), ['invoice_number'], unique=True)
        batch_op.create_index(batch_op.f('ix_payrolls_period_end'), ['period_end'], unique=False)
        batch_op.create_index(batch_op.f('ix_payrolls_period_start'), ['period_start'], unique=False)
        batch_op.create_index(batch_op.f('ix_payrolls_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_payrolls_user_id'), ['user_id'], unique=False)

    with op.batch_alter_table('permissions', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('resource',
               existing_type=sa.VARCHAR(length=128),
               type_=sa.String(length=64),
               existing_nullable=False)
        batch_op.alter_column('action',
               existing_type=sa.VARCHAR(length=64),
               type_=sa.String(length=32),
               existing_nullable=False)
        batch_op.drop_index(batch_op.f('idx_permissions_action'))
        batch_op.drop_index(batch_op.f('idx_permissions_name'))
        batch_op.drop_index(batch_op.f('idx_permissions_resource'))
        batch_op.create_index(batch_op.f('ix_permissions_action'), ['action'], unique=False)
        batch_op.create_index(batch_op.f('ix_permissions_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_permissions_name'), ['name'], unique=True)
        batch_op.create_index(batch_op.f('ix_permissions_resource'), ['resource'], unique=False)

    with op.batch_alter_table('role_permissions', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('idx_role_permissions_permission_id'))
        batch_op.drop_index(batch_op.f('idx_role_permissions_role_id'))
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'roles', ['role_id'], ['id'])
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'permissions', ['permission_id'], ['id'])
        batch_op.drop_column('id')
        batch_op.drop_column('created_at')

    with op.batch_alter_table('roles', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.drop_index(batch_op.f('idx_roles_name'))
        batch_op.create_index(batch_op.f('ix_roles_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_roles_name'), ['name'], unique=True)
        batch_op.drop_column('is_system_role')

    with op.batch_alter_table('security_patrol_logs', schema=None) as batch_op:
        batch_op.alter_column('distance_covered',
               existing_type=sa.REAL(),
               type_=sa.Float(),
               existing_nullable=True)
        batch_op.drop_index(batch_op.f('ix_security_patrol_logs_gps_track_id'))
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'patrol_teams', ['team_id'], ['id'])
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'patrol_routes', ['route_id'], ['id'])
        batch_op.drop_column('status')

    with op.batch_alter_table('security_reports', schema=None) as batch_op:
        batch_op.alter_column('division',
               existing_type=sa.VARCHAR(length=32),
               nullable=False)
        batch_op.alter_column('incident_category',
               existing_type=sa.TEXT(),
               type_=sa.String(length=64),
               existing_nullable=True)
        batch_op.alter_column('incident_level',
               existing_type=sa.TEXT(),
               type_=sa.String(length=32),
               existing_nullable=True)
        batch_op.alter_column('perpetrator_name',
               existing_type=sa.TEXT(),
               type_=sa.String(length=255),
               existing_nullable=True)
        batch_op.alter_column('perpetrator_type',
               existing_type=sa.TEXT(),
               type_=sa.String(length=32),
               existing_nullable=True)
        batch_op.create_index(batch_op.f('ix_security_reports_checklist_id'), ['checklist_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_security_reports_trip_id'), ['trip_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_security_reports_vehicle_id'), ['vehicle_id'], unique=False)

    with op.batch_alter_table('shift_handovers', schema=None) as batch_op:
        batch_op.alter_column('priority_items',
               existing_type=sa.TEXT(),
               type_=sa.JSON(),
               existing_nullable=True)
        batch_op.alter_column('pending_tasks',
               existing_type=sa.TEXT(),
               type_=sa.JSON(),
               existing_nullable=True)

    with op.batch_alter_table('shifts', schema=None) as batch_op:
        batch_op.alter_column('overtime_hours',
               existing_type=sa.REAL(),
               type_=sa.Integer(),
               nullable=False)
        batch_op.alter_column('break_duration_minutes',
               existing_type=sa.INTEGER(),
               nullable=False)
        batch_op.drop_index(batch_op.f('idx_shifts_actual_end_time'))
        batch_op.drop_index(batch_op.f('idx_shifts_actual_start_time'))
        batch_op.drop_index(batch_op.f('idx_shifts_scheduled_end_time'))
        batch_op.drop_index(batch_op.f('idx_shifts_scheduled_start_time'))
        batch_op.drop_index(batch_op.f('idx_shifts_shift_category'))

    with op.batch_alter_table('sites', schema=None) as batch_op:
        batch_op.alter_column('lat',
               existing_type=sa.REAL(),
               type_=sa.Float(),
               existing_nullable=True)
        batch_op.alter_column('lng',
               existing_type=sa.REAL(),
               type_=sa.Float(),
               existing_nullable=True)
        batch_op.alter_column('geofence_radius_m',
               existing_type=sa.REAL(),
               type_=sa.Float(),
               existing_nullable=True,
               existing_server_default=sa.text('(100.0)'))
        batch_op.create_index(batch_op.f('ix_sites_qr_code'), ['qr_code'], unique=True)

    with op.batch_alter_table('sync_queue', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('operation_type',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.Enum('CREATE', 'UPDATE', 'DELETE', name='syncoperationtype'),
               existing_nullable=False)
        batch_op.alter_column('data',
               existing_type=sa.TEXT(),
               type_=sa.JSON(),
               existing_nullable=False)
        batch_op.alter_column('original_data',
               existing_type=sa.TEXT(),
               type_=sa.JSON(),
               existing_nullable=True)
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.Enum('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'RETRY', name='syncstatus'),
               existing_nullable=False,
               existing_server_default=sa.text("'PENDING'"))
        batch_op.alter_column('error_details',
               existing_type=sa.TEXT(),
               type_=sa.JSON(),
               existing_nullable=True)
        batch_op.drop_index(batch_op.f('idx_sync_queue_company_id'))
        batch_op.drop_index(batch_op.f('idx_sync_queue_created_at'))
        batch_op.drop_index(batch_op.f('idx_sync_queue_operation_type'))
        batch_op.drop_index(batch_op.f('idx_sync_queue_resource_type'))
        batch_op.drop_index(batch_op.f('idx_sync_queue_status'))
        batch_op.drop_index(batch_op.f('idx_sync_queue_user_id'))
        batch_op.create_index(batch_op.f('ix_sync_queue_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sync_queue_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_sync_queue_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sync_queue_operation_type'), ['operation_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_sync_queue_resource_type'), ['resource_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_sync_queue_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_sync_queue_user_id'), ['user_id'], unique=False)

    with op.batch_alter_table('training_attendances', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('attendance_status',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.Enum('REGISTERED', 'ATTENDED', 'ABSENT', 'CANCELLED', name='trainingattendancestatus'),
               existing_nullable=False,
               existing_server_default=sa.text("'REGISTERED'"))
        batch_op.drop_index(batch_op.f('idx_training_attendances_training_id'))
        batch_op.drop_index(batch_op.f('idx_training_attendances_user_id'))
        batch_op.create_index(batch_op.f('ix_training_attendances_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_training_attendances_training_id'), ['training_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_training_attendances_user_id'), ['user_id'], unique=False)

    with op.batch_alter_table('trainings', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.Enum('SCHEDULED', 'ONGOING', 'COMPLETED', 'CANCELLED', 'POSTPONED', name='trainingstatus'),
               existing_nullable=False,
               existing_server_default=sa.text("'SCHEDULED'"))
        batch_op.drop_index(batch_op.f('idx_trainings_category'))
        batch_op.drop_index(batch_op.f('idx_trainings_company_id'))
        batch_op.drop_index(batch_op.f('idx_trainings_division'))
        batch_op.drop_index(batch_op.f('idx_trainings_scheduled_date'))
        batch_op.drop_index(batch_op.f('idx_trainings_site_id'))
        batch_op.drop_index(batch_op.f('idx_trainings_status'))
        batch_op.create_index(batch_op.f('ix_trainings_category'), ['category'], unique=False)
        batch_op.create_index(batch_op.f('ix_trainings_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_trainings_division'), ['division'], unique=False)
        batch_op.create_index(batch_op.f('ix_trainings_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_trainings_scheduled_date'), ['scheduled_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_trainings_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_trainings_status'), ['status'], unique=False)

    with op.batch_alter_table('user_permissions', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('idx_user_permissions_permission_id'))
        batch_op.drop_index(batch_op.f('idx_user_permissions_user_id'))
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'users', ['user_id'], ['id'])
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'permissions', ['permission_id'], ['id'])

    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.alter_column('division',
               existing_type=sa.VARCHAR(),
               nullable=True)
        batch_op.create_index(batch_op.f('ix_users_role'), ['role'], unique=False)
        batch_op.create_index(batch_op.f('ix_users_scope_id'), ['scope_id'], unique=False)
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'roles', ['role_id'], ['id'])
        batch_op.drop_column('name')

    with op.batch_alter_table('visitors', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=False,
               autoincrement=True)
        batch_op.drop_index(batch_op.f('idx_visitors_category'))
        batch_op.drop_index(batch_op.f('idx_visitors_check_in_time'))
        batch_op.drop_index(batch_op.f('idx_visitors_check_out_time'))
        batch_op.drop_index(batch_op.f('idx_visitors_company_id'))
        batch_op.drop_index(batch_op.f('idx_visitors_is_checked_in'))
        batch_op.drop_index(batch_op.f('idx_visitors_site_id'))
        batch_op.drop_index(batch_op.f('idx_visitors_status'))
        batch_op.drop_index(batch_op.f('idx_visitors_visit_date'))
        batch_op.create_index(batch_op.f('ix_visitors_category'), ['category'], unique=False)
        batch_op.create_index(batch_op.f('ix_visitors_check_in_time'), ['check_in_time'], unique=False)
        batch_op.create_index(batch_op.f('ix_visitors_check_out_time'), ['check_out_time'], unique=False)
        batch_op.create_index(batch_op.f('ix_visitors_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_visitors_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_visitors_is_checked_in'), ['is_checked_in'], unique=False)
        batch_op.create_index(batch_op.f('ix_visitors_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_visitors_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_visitors_visit_date'), ['visit_date'], unique=False)

    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('visitors', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_visitors_visit_date'))
        batch_op.drop_index(batch_op.f('ix_visitors_status'))
        batch_op.drop_index(batch_op.f('ix_visitors_site_id'))
        batch_op.drop_index(batch_op.f('ix_visitors_is_checked_in'))
        batch_op.drop_index(batch_op.f('ix_visitors_id'))
        batch_op.drop_index(batch_op.f('ix_visitors_company_id'))
        batch_op.drop_index(batch_op.f('ix_visitors_check_out_time'))
        batch_op.drop_index(batch_op.f('ix_visitors_check_in_time'))
        batch_op.drop_index(batch_op.f('ix_visitors_category'))
        batch_op.create_index(batch_op.f('idx_visitors_visit_date'), ['visit_date'], unique=False)
        batch_op.create_index(batch_op.f('idx_visitors_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('idx_visitors_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_visitors_is_checked_in'), ['is_checked_in'], unique=False)
        batch_op.create_index(batch_op.f('idx_visitors_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_visitors_check_out_time'), ['check_out_time'], unique=False)
        batch_op.create_index(batch_op.f('idx_visitors_check_in_time'), ['check_in_time'], unique=False)
        batch_op.create_index(batch_op.f('idx_visitors_category'), ['category'], unique=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.add_column(sa.Column('name', sa.TEXT(), nullable=True))
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        batch_op.drop_index(batch_op.f('ix_users_scope_id'))
        batch_op.drop_index(batch_op.f('ix_users_role'))
        batch_op.alter_column('division',
               existing_type=sa.VARCHAR(),
               nullable=False)

    with op.batch_alter_table('user_permissions', schema=None) as batch_op:
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'users', ['user_id'], ['id'], ondelete='CASCADE')
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'permissions', ['permission_id'], ['id'], ondelete='CASCADE')
        batch_op.create_index(batch_op.f('idx_user_permissions_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_user_permissions_permission_id'), ['permission_id'], unique=False)

    with op.batch_alter_table('trainings', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_trainings_status'))
        batch_op.drop_index(batch_op.f('ix_trainings_site_id'))
        batch_op.drop_index(batch_op.f('ix_trainings_scheduled_date'))
        batch_op.drop_index(batch_op.f('ix_trainings_id'))
        batch_op.drop_index(batch_op.f('ix_trainings_division'))
        batch_op.drop_index(batch_op.f('ix_trainings_company_id'))
        batch_op.drop_index(batch_op.f('ix_trainings_category'))
        batch_op.create_index(batch_op.f('idx_trainings_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('idx_trainings_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_trainings_scheduled_date'), ['scheduled_date'], unique=False)
        batch_op.create_index(batch_op.f('idx_trainings_division'), ['division'], unique=False)
        batch_op.create_index(batch_op.f('idx_trainings_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_trainings_category'), ['category'], unique=False)
        batch_op.alter_column('status',
               existing_type=sa.Enum('SCHEDULED', 'ONGOING', 'COMPLETED', 'CANCELLED', 'POSTPONED', name='trainingstatus'),
               type_=sa.VARCHAR(length=32),
               existing_nullable=False,
               existing_server_default=sa.text("'SCHEDULED'"))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('training_attendances', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_training_attendances_user_id'))
        batch_op.drop_index(batch_op.f('ix_training_attendances_training_id'))
        batch_op.drop_index(batch_op.f('ix_training_attendances_id'))
        batch_op.create_index(batch_op.f('idx_training_attendances_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_training_attendances_training_id'), ['training_id'], unique=False)
        batch_op.alter_column('attendance_status',
               existing_type=sa.Enum('REGISTERED', 'ATTENDED', 'ABSENT', 'CANCELLED', name='trainingattendancestatus'),
               type_=sa.VARCHAR(length=32),
               existing_nullable=False,
               existing_server_default=sa.text("'REGISTERED'"))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('sync_queue', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_sync_queue_user_id'))
        batch_op.drop_index(batch_op.f('ix_sync_queue_status'))
        batch_op.drop_index(batch_op.f('ix_sync_queue_resource_type'))
        batch_op.drop_index(batch_op.f('ix_sync_queue_operation_type'))
        batch_op.drop_index(batch_op.f('ix_sync_queue_id'))
        batch_op.drop_index(batch_op.f('ix_sync_queue_created_at'))
        batch_op.drop_index(batch_op.f('ix_sync_queue_company_id'))
        batch_op.create_index(batch_op.f('idx_sync_queue_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_sync_queue_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('idx_sync_queue_resource_type'), ['resource_type'], unique=False)
        batch_op.create_index(batch_op.f('idx_sync_queue_operation_type'), ['operation_type'], unique=False)
        batch_op.create_index(batch_op.f('idx_sync_queue_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('idx_sync_queue_company_id'), ['company_id'], unique=False)
        batch_op.alter_column('error_details',
               existing_type=sa.JSON(),
               type_=sa.TEXT(),
               existing_nullable=True)
        batch_op.alter_column('status',
               existing_type=sa.Enum('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'RETRY', name='syncstatus'),
               type_=sa.VARCHAR(length=32),
               existing_nullable=False,
               existing_server_default=sa.text("'PENDING'"))
        batch_op.alter_column('original_data',
               existing_type=sa.JSON(),
               type_=sa.TEXT(),
               existing_nullable=True)
        batch_op.alter_column('data',
               existing_type=sa.JSON(),
               type_=sa.TEXT(),
               existing_nullable=False)
        batch_op.alter_column('operation_type',
               existing_type=sa.Enum('CREATE', 'UPDATE', 'DELETE', name='syncoperationtype'),
               type_=sa.VARCHAR(length=32),
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('sites', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_sites_qr_code'))
        batch_op.alter_column('geofence_radius_m',
               existing_type=sa.Float(),
               type_=sa.REAL(),
               existing_nullable=True,
               existing_server_default=sa.text('(100.0)'))
        batch_op.alter_column('lng',
               existing_type=sa.Float(),
               type_=sa.REAL(),
               existing_nullable=True)
        batch_op.alter_column('lat',
               existing_type=sa.Float(),
               type_=sa.REAL(),
               existing_nullable=True)

    with op.batch_alter_table('shifts', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('idx_shifts_shift_category'), ['shift_category'], unique=False)
        batch_op.create_index(batch_op.f('idx_shifts_scheduled_start_time'), ['scheduled_start_time'], unique=False)
        batch_op.create_index(batch_op.f('idx_shifts_scheduled_end_time'), ['scheduled_end_time'], unique=False)
        batch_op.create_index(batch_op.f('idx_shifts_actual_start_time'), ['actual_start_time'], unique=False)
        batch_op.create_index(batch_op.f('idx_shifts_actual_end_time'), ['actual_end_time'], unique=False)
        batch_op.alter_column('break_duration_minutes',
               existing_type=sa.INTEGER(),
               nullable=True)
        batch_op.alter_column('overtime_hours',
               existing_type=sa.Integer(),
               type_=sa.REAL(),
               nullable=True)

    with op.batch_alter_table('shift_handovers', schema=None) as batch_op:
        batch_op.alter_column('pending_tasks',
               existing_type=sa.JSON(),
               type_=sa.TEXT(),
               existing_nullable=True)
        batch_op.alter_column('priority_items',
               existing_type=sa.JSON(),
               type_=sa.TEXT(),
               existing_nullable=True)

    with op.batch_alter_table('security_reports', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_security_reports_vehicle_id'))
        batch_op.drop_index(batch_op.f('ix_security_reports_trip_id'))
        batch_op.drop_index(batch_op.f('ix_security_reports_checklist_id'))
        batch_op.alter_column('perpetrator_type',
               existing_type=sa.String(length=32),
               type_=sa.TEXT(),
               existing_nullable=True)
        batch_op.alter_column('perpetrator_name',
               existing_type=sa.String(length=255),
               type_=sa.TEXT(),
               existing_nullable=True)
        batch_op.alter_column('incident_level',
               existing_type=sa.String(length=32),
               type_=sa.TEXT(),
               existing_nullable=True)
        batch_op.alter_column('incident_category',
               existing_type=sa.String(length=64),
               type_=sa.TEXT(),
               existing_nullable=True)
        batch_op.alter_column('division',
               existing_type=sa.VARCHAR(length=32),
               nullable=True)

    with op.batch_alter_table('security_patrol_logs', schema=None) as batch_op:
        batch_op.add_column(sa.Column('status', sa.VARCHAR(length=32), server_default=sa.text("'partial'"), nullable=True))
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        batch_op.create_index(batch_op.f('ix_security_patrol_logs_gps_track_id'), ['gps_track_id'], unique=False)
        batch_op.alter_column('distance_covered',
               existing_type=sa.Float(),
               type_=sa.REAL(),
               existing_nullable=True)

    with op.batch_alter_table('roles', schema=None) as batch_op:
        batch_op.add_column(sa.Column('is_system_role', sa.BOOLEAN(), server_default=sa.text('0'), nullable=False))
        batch_op.drop_index(batch_op.f('ix_roles_name'))
        batch_op.drop_index(batch_op.f('ix_roles_id'))
        batch_op.create_index(batch_op.f('idx_roles_name'), ['name'], unique=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('role_permissions', schema=None) as batch_op:
        batch_op.add_column(sa.Column('created_at', sa.DATETIME(), nullable=False))
        batch_op.add_column(sa.Column('id', sa.INTEGER(), nullable=True))
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'permissions', ['permission_id'], ['id'], ondelete='CASCADE')
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'roles', ['role_id'], ['id'], ondelete='CASCADE')
        batch_op.create_index(batch_op.f('idx_role_permissions_role_id'), ['role_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_role_permissions_permission_id'), ['permission_id'], unique=False)

    with op.batch_alter_table('permissions', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_permissions_resource'))
        batch_op.drop_index(batch_op.f('ix_permissions_name'))
        batch_op.drop_index(batch_op.f('ix_permissions_id'))
        batch_op.drop_index(batch_op.f('ix_permissions_action'))
        batch_op.create_index(batch_op.f('idx_permissions_resource'), ['resource'], unique=False)
        batch_op.create_index(batch_op.f('idx_permissions_name'), ['name'], unique=False)
        batch_op.create_index(batch_op.f('idx_permissions_action'), ['action'], unique=False)
        batch_op.alter_column('action',
               existing_type=sa.String(length=32),
               type_=sa.VARCHAR(length=64),
               existing_nullable=False)
        batch_op.alter_column('resource',
               existing_type=sa.String(length=64),
               type_=sa.VARCHAR(length=128),
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('payrolls', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_payrolls_user_id'))
        batch_op.drop_index(batch_op.f('ix_payrolls_status'))
        batch_op.drop_index(batch_op.f('ix_payrolls_period_start'))
        batch_op.drop_index(batch_op.f('ix_payrolls_period_end'))
        batch_op.drop_index(batch_op.f('ix_payrolls_invoice_number'))
        batch_op.drop_index(batch_op.f('ix_payrolls_id'))
        batch_op.drop_index(batch_op.f('ix_payrolls_company_id'))
        batch_op.create_index(batch_op.f('idx_payrolls_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_payrolls_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('idx_payrolls_period_start'), ['period_start'], unique=False)
        batch_op.create_index(batch_op.f('idx_payrolls_period_end'), ['period_end'], unique=False)
        batch_op.create_index(batch_op.f('idx_payrolls_invoice_number'), ['invoice_number'], unique=False)
        batch_op.create_index(batch_op.f('idx_payrolls_company_id'), ['company_id'], unique=False)
        batch_op.alter_column('status',
               existing_type=sa.Enum('DRAFT', 'APPROVED', 'PAID', 'CANCELLED', name='payrollstatus'),
               type_=sa.VARCHAR(length=32),
               existing_nullable=False,
               existing_server_default=sa.text("'DRAFT'"))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('payments', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_payments_transaction_id'))
        batch_op.drop_index(batch_op.f('ix_payments_status'))
        batch_op.drop_index(batch_op.f('ix_payments_payroll_id'))
        batch_op.drop_index(batch_op.f('ix_payments_id'))
        batch_op.create_index(batch_op.f('idx_payments_transaction_id'), ['transaction_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_payments_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('idx_payments_payroll_id'), ['payroll_id'], unique=False)
        batch_op.alter_column('status',
               existing_type=sa.Enum('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'CANCELLED', name='paymentstatus'),
               type_=sa.VARCHAR(length=32),
               existing_nullable=False,
               existing_server_default=sa.text("'PENDING'"))
        batch_op.alter_column('payment_method',
               existing_type=sa.Enum('BANK_TRANSFER', 'CASH', 'E_WALLET', 'PAYMENT_GATEWAY', name='paymentmethod'),
               type_=sa.VARCHAR(length=32),
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('patrol_teams', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_patrol_teams_site_id'))
        batch_op.drop_index(batch_op.f('ix_patrol_teams_is_active'))
        batch_op.drop_index(batch_op.f('ix_patrol_teams_id'))
        batch_op.drop_index(batch_op.f('ix_patrol_teams_division'))
        batch_op.drop_index(batch_op.f('ix_patrol_teams_company_id'))
        batch_op.create_index(batch_op.f('idx_patrol_teams_team_leader_id'), ['team_leader_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_patrol_teams_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_patrol_teams_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('idx_patrol_teams_division'), ['division'], unique=False)
        batch_op.create_index(batch_op.f('idx_patrol_teams_company_id'), ['company_id'], unique=False)
        batch_op.alter_column('assigned_routes',
               existing_type=sa.JSON(),
               type_=sa.TEXT(),
               existing_nullable=True)
        batch_op.alter_column('team_members',
               existing_type=sa.JSON(),
               type_=sa.TEXT(),
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('patrol_targets', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_patrol_targets_zone_id'))
        batch_op.drop_index(batch_op.f('ix_patrol_targets_target_date'))
        batch_op.drop_index(batch_op.f('ix_patrol_targets_status'))
        batch_op.drop_index(batch_op.f('ix_patrol_targets_site_id'))
        batch_op.drop_index(batch_op.f('ix_patrol_targets_route_id'))
        batch_op.drop_index(batch_op.f('ix_patrol_targets_id'))
        batch_op.drop_index(batch_op.f('ix_patrol_targets_company_id'))
        batch_op.create_index(batch_op.f('idx_patrol_targets_zone_id'), ['zone_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_patrol_targets_target_date'), ['target_date'], unique=False)
        batch_op.create_index(batch_op.f('idx_patrol_targets_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('idx_patrol_targets_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_patrol_targets_route_id'), ['route_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_patrol_targets_company_id'), ['company_id'], unique=False)
        batch_op.alter_column('completion_percentage',
               existing_type=sa.Float(),
               type_=sa.REAL(),
               existing_nullable=False,
               existing_server_default=sa.text('(0.0)'))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('master_data', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_master_data_parent_id'))
        batch_op.drop_index(batch_op.f('ix_master_data_is_active'))
        batch_op.drop_index(batch_op.f('ix_master_data_id'))
        batch_op.drop_index(batch_op.f('ix_master_data_division'))
        batch_op.drop_index(batch_op.f('ix_master_data_company_id'))
        batch_op.drop_index(batch_op.f('ix_master_data_code'))
        batch_op.drop_index(batch_op.f('ix_master_data_category'))
        batch_op.create_index(batch_op.f('idx_master_data_parent_id'), ['parent_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_master_data_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('idx_master_data_division'), ['division'], unique=False)
        batch_op.create_index(batch_op.f('idx_master_data_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_master_data_code'), ['code'], unique=False)
        batch_op.create_index(batch_op.f('idx_master_data_category'), ['category'], unique=False)
        batch_op.alter_column('sort_order',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
        batch_op.alter_column('extra_data',
               existing_type=sa.JSON(),
               type_=sa.TEXT(),
               existing_nullable=True)
        batch_op.alter_column('code',
               existing_type=sa.VARCHAR(length=128),
               nullable=True)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('leave_requests', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_leave_requests_created_at'))
        batch_op.alter_column('updated_at',
               existing_type=sa.DATETIME(),
               nullable=False)
        batch_op.alter_column('created_at',
               existing_type=sa.DATETIME(),
               nullable=False)

    with op.batch_alter_table('gps_tracks', schema=None) as batch_op:
        batch_op.add_column(sa.Column('track_data', sa.TEXT(), nullable=False))
        batch_op.add_column(sa.Column('end_time', sa.DATETIME(), nullable=True))
        batch_op.add_column(sa.Column('patrol_log_id', sa.INTEGER(), nullable=True))
        batch_op.add_column(sa.Column('duration_minutes', sa.INTEGER(), nullable=True))
        batch_op.add_column(sa.Column('start_time', sa.DATETIME(), nullable=False))
        batch_op.add_column(sa.Column('distance_km', sa.REAL(), nullable=True))
        # batch_op.create_foreign_key(None,  # Commented out - SQLite batch mode doesn't support unnamed constraints 'security_patrol_logs', ['patrol_log_id'], ['id'])
        batch_op.drop_index(batch_op.f('ix_gps_tracks_user_id'))
        batch_op.drop_index(batch_op.f('ix_gps_tracks_track_type'))
        batch_op.drop_index(batch_op.f('ix_gps_tracks_track_reference_id'))
        batch_op.drop_index(batch_op.f('ix_gps_tracks_site_id'))
        batch_op.drop_index(batch_op.f('ix_gps_tracks_recorded_at'))
        batch_op.drop_index(batch_op.f('ix_gps_tracks_id'))
        batch_op.drop_index(batch_op.f('ix_gps_tracks_company_id'))
        batch_op.create_index(batch_op.f('idx_gps_tracks_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_gps_tracks_track_type'), ['track_type'], unique=False)
        batch_op.create_index(batch_op.f('idx_gps_tracks_track_reference_id'), ['track_reference_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_gps_tracks_start_time'), ['start_time'], unique=False)
        batch_op.create_index(batch_op.f('idx_gps_tracks_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_gps_tracks_recorded_at'), ['recorded_at'], unique=False)
        batch_op.create_index(batch_op.f('idx_gps_tracks_patrol_log_id'), ['patrol_log_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_gps_tracks_company_id'), ['company_id'], unique=False)
        batch_op.alter_column('speed',
               existing_type=sa.Float(),
               type_=sa.REAL(),
               existing_nullable=True)
        batch_op.alter_column('accuracy',
               existing_type=sa.Float(),
               type_=sa.REAL(),
               existing_nullable=True)
        batch_op.alter_column('altitude',
               existing_type=sa.Float(),
               type_=sa.REAL(),
               existing_nullable=True)
        batch_op.alter_column('longitude',
               existing_type=sa.Float(),
               type_=sa.REAL(),
               existing_nullable=False,
               existing_server_default=sa.text('0'))
        batch_op.alter_column('latitude',
               existing_type=sa.Float(),
               type_=sa.REAL(),
               existing_nullable=False,
               existing_server_default=sa.text('0'))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('employees', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_employees_user_id'))
        batch_op.drop_index(batch_op.f('ix_employees_status'))
        batch_op.drop_index(batch_op.f('ix_employees_site_id'))
        batch_op.drop_index(batch_op.f('ix_employees_nik'))
        batch_op.drop_index(batch_op.f('ix_employees_id'))
        batch_op.drop_index(batch_op.f('ix_employees_employee_number'))
        batch_op.drop_index(batch_op.f('ix_employees_email'))
        batch_op.drop_index(batch_op.f('ix_employees_company_id'))
        batch_op.create_index(batch_op.f('idx_employees_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_employees_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('idx_employees_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_employees_nik'), ['nik'], unique=False)
        batch_op.create_index(batch_op.f('idx_employees_employee_number'), ['employee_number'], unique=False)
        batch_op.create_index(batch_op.f('idx_employees_email'), ['email'], unique=False)
        batch_op.create_index(batch_op.f('idx_employees_company_id'), ['company_id'], unique=False)
        batch_op.alter_column('status',
               existing_type=sa.Enum('ACTIVE', 'INACTIVE', 'TERMINATED', 'ON_LEAVE', name='employeestatus'),
               type_=sa.VARCHAR(length=32),
               existing_nullable=False,
               existing_server_default=sa.text("'ACTIVE'"))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('employee_contracts', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_employee_contracts_status'))
        batch_op.drop_index(batch_op.f('ix_employee_contracts_start_date'))
        batch_op.drop_index(batch_op.f('ix_employee_contracts_id'))
        batch_op.drop_index(batch_op.f('ix_employee_contracts_end_date'))
        batch_op.drop_index(batch_op.f('ix_employee_contracts_employee_id'))
        batch_op.drop_index(batch_op.f('ix_employee_contracts_contract_number'))
        batch_op.create_index(batch_op.f('idx_employee_contracts_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('idx_employee_contracts_start_date'), ['start_date'], unique=False)
        batch_op.create_index(batch_op.f('idx_employee_contracts_end_date'), ['end_date'], unique=False)
        batch_op.create_index(batch_op.f('idx_employee_contracts_employee_id'), ['employee_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_employee_contracts_contract_number'), ['contract_number'], unique=False)
        batch_op.alter_column('contract_type',
               existing_type=sa.Enum('PERMANENT', 'CONTRACT', 'INTERNSHIP', 'PART_TIME', name='contracttype'),
               type_=sa.VARCHAR(length=32),
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('documents', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_documents_status'))
        batch_op.drop_index(batch_op.f('ix_documents_id'))
        batch_op.drop_index(batch_op.f('ix_documents_effective_date'))
        batch_op.drop_index(batch_op.f('ix_documents_document_type'))
        batch_op.drop_index(batch_op.f('ix_documents_document_number'))
        batch_op.drop_index(batch_op.f('ix_documents_division'))
        batch_op.drop_index(batch_op.f('ix_documents_company_id'))
        batch_op.drop_index(batch_op.f('ix_documents_category'))
        batch_op.create_index(batch_op.f('idx_documents_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('idx_documents_effective_date'), ['effective_date'], unique=False)
        batch_op.create_index(batch_op.f('idx_documents_document_type'), ['document_type'], unique=False)
        batch_op.create_index(batch_op.f('idx_documents_document_number'), ['document_number'], unique=False)
        batch_op.create_index(batch_op.f('idx_documents_division'), ['division'], unique=False)
        batch_op.create_index(batch_op.f('idx_documents_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_documents_category'), ['category'], unique=False)
        batch_op.alter_column('status',
               existing_type=sa.Enum('DRAFT', 'UNDER_REVIEW', 'APPROVED', 'ACTIVE', 'ARCHIVED', 'OBSOLETE', name='documentstatus'),
               type_=sa.VARCHAR(length=32),
               existing_nullable=False,
               existing_server_default=sa.text("'DRAFT'"))
        batch_op.alter_column('document_type',
               existing_type=sa.Enum('SOP', 'WORK_INSTRUCTION', 'POLICY', 'MANUAL', 'FORM', 'OTHER', name='documenttype'),
               type_=sa.VARCHAR(length=32),
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('document_versions', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_document_versions_id'))
        batch_op.drop_index(batch_op.f('ix_document_versions_document_id'))
        batch_op.create_index(batch_op.f('idx_document_versions_document_id'), ['document_id'], unique=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('development_plans', schema=None) as batch_op:
        batch_op.add_column(sa.Column('evaluation_notes', sa.TEXT(), nullable=True))
        batch_op.add_column(sa.Column('end_date', sa.DATE(), nullable=True))
        batch_op.add_column(sa.Column('progress_percentage', sa.REAL(), server_default=sa.text('(0.0)'), nullable=False))
        batch_op.add_column(sa.Column('completed_at', sa.DATETIME(), nullable=True))
        # batch_op.drop_constraint(None, type_='foreignkey')  # Commented out - SQLite batch mode doesn't support unnamed constraints
        batch_op.drop_index(batch_op.f('ix_development_plans_user_id'))
        batch_op.drop_index(batch_op.f('ix_development_plans_target_date'))
        batch_op.drop_index(batch_op.f('ix_development_plans_status'))
        batch_op.drop_index(batch_op.f('ix_development_plans_id'))
        batch_op.drop_index(batch_op.f('ix_development_plans_company_id'))
        batch_op.create_index(batch_op.f('idx_development_plans_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_development_plans_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('idx_development_plans_company_id'), ['company_id'], unique=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)
        batch_op.drop_column('notes')
        batch_op.drop_column('evaluated_by')
        batch_op.drop_column('evaluation_date')
        batch_op.drop_column('evaluation')
        batch_op.drop_column('completion_date')

    with op.batch_alter_table('cleaning_zones', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_cleaning_zones_division'))
        batch_op.alter_column('division',
               existing_type=sa.VARCHAR(length=32),
               nullable=True)

    with op.batch_alter_table('checklists', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_checklists_division'))
        batch_op.drop_index(batch_op.f('ix_checklists_context_type'))
        batch_op.drop_index(batch_op.f('ix_checklists_context_id'))
        batch_op.alter_column('division',
               existing_type=sa.String(length=32),
               type_=sa.TEXT(),
               nullable=True)

    with op.batch_alter_table('checklist_templates', schema=None) as batch_op:
        batch_op.alter_column('division',
               existing_type=sa.VARCHAR(length=32),
               nullable=True)

    with op.batch_alter_table('checklist_template_items', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_checklist_template_items_kpi_key'))
        batch_op.alter_column('photo_required',
               existing_type=sa.BOOLEAN(),
               nullable=True,
               existing_server_default=sa.text('0'))

    with op.batch_alter_table('checklist_items', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_checklist_items_kpi_key'))
        batch_op.alter_column('mock_location',
               existing_type=sa.BOOLEAN(),
               nullable=True)

    with op.batch_alter_table('cctv_cameras', schema=None) as batch_op:
        batch_op.add_column(sa.Column('position_lat', sa.REAL(), nullable=True))
        batch_op.add_column(sa.Column('description', sa.TEXT(), nullable=True))
        batch_op.add_column(sa.Column('position_lng', sa.REAL(), nullable=True))
        batch_op.drop_index(batch_op.f('ix_cctv_cameras_zone_name'))
        batch_op.drop_index(batch_op.f('ix_cctv_cameras_site_id'))
        batch_op.drop_index(batch_op.f('ix_cctv_cameras_id'))
        batch_op.drop_index(batch_op.f('ix_cctv_cameras_company_id'))
        batch_op.create_index(batch_op.f('idx_cctv_cameras_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_cctv_cameras_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('idx_cctv_cameras_company_id'), ['company_id'], unique=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)
        batch_op.drop_column('zone_name')

    with op.batch_alter_table('audit_logs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_audit_logs_user_id'))
        batch_op.drop_index(batch_op.f('ix_audit_logs_resource_type'))
        batch_op.drop_index(batch_op.f('ix_audit_logs_resource_id'))
        batch_op.drop_index(batch_op.f('ix_audit_logs_id'))
        batch_op.drop_index(batch_op.f('ix_audit_logs_created_at'))
        batch_op.drop_index(batch_op.f('ix_audit_logs_company_id'))
        batch_op.drop_index(batch_op.f('ix_audit_logs_action'))
        batch_op.create_index(batch_op.f('idx_audit_logs_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_audit_logs_resource_type'), ['resource_type'], unique=False)
        batch_op.create_index(batch_op.f('idx_audit_logs_resource_id'), ['resource_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_audit_logs_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('idx_audit_logs_company_id'), ['company_id'], unique=False)
        batch_op.create_index(batch_op.f('idx_audit_logs_action'), ['action'], unique=False)
        batch_op.alter_column('user_agent',
               existing_type=sa.String(length=512),
               type_=sa.TEXT(),
               existing_nullable=True)
        batch_op.alter_column('user_id',
               existing_type=sa.INTEGER(),
               nullable=True)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               nullable=True,
               autoincrement=True)

    with op.batch_alter_table('attendance', schema=None) as batch_op:
        batch_op.alter_column('is_backup',
               existing_type=sa.Boolean(),
               type_=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
        batch_op.alter_column('is_overtime',
               existing_type=sa.Boolean(),
               type_=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))

    op.create_table('bap_reports',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('company_id', sa.INTEGER(), nullable=False),
    sa.Column('site_id', sa.INTEGER(), nullable=False),
    sa.Column('incident_type', sa.VARCHAR(length=20), nullable=False),
    sa.Column('incident_number', sa.VARCHAR(length=50), nullable=False),
    sa.Column('incident_date', sa.DATE(), nullable=False),
    sa.Column('reported_by', sa.INTEGER(), nullable=False),
    sa.Column('status', sa.VARCHAR(length=20), server_default=sa.text("'DRAFT'"), nullable=False),
    sa.Column('title', sa.VARCHAR(length=255), nullable=False),
    sa.Column('description', sa.TEXT(), nullable=True),
    sa.Column('location', sa.VARCHAR(length=255), nullable=True),
    sa.Column('evidence_paths', sa.TEXT(), nullable=True),
    sa.Column('investigation_date', sa.DATE(), nullable=True),
    sa.Column('investigator_name', sa.VARCHAR(length=255), nullable=True),
    sa.Column('subject_name', sa.VARCHAR(length=255), nullable=True),
    sa.Column('subject_id_number', sa.VARCHAR(length=100), nullable=True),
    sa.Column('investigation_findings', sa.TEXT(), nullable=True),
    sa.Column('recommendations', sa.TEXT(), nullable=True),
    sa.Column('related_incident_id', sa.INTEGER(), nullable=True),
    sa.Column('created_at', sa.DATETIME(), nullable=False),
    sa.Column('updated_at', sa.DATETIME(), nullable=False),
    sa.ForeignKeyConstraint(['reported_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['site_id'], ['sites.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('incident_number')
    )
    with op.batch_alter_table('bap_reports', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_bap_reports_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_bap_reports_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_bap_reports_company_id'), ['company_id'], unique=False)

    op.create_table('patrol_reports',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('assignment_id', sa.INTEGER(), nullable=False),
    sa.Column('report_date', sa.DATE(), nullable=False),
    sa.Column('summary', sa.TEXT(), nullable=True),
    sa.Column('incidents_found', sa.INTEGER(), server_default=sa.text("'0'"), nullable=False),
    sa.Column('checkpoints_scanned', sa.INTEGER(), server_default=sa.text("'0'"), nullable=False),
    sa.Column('status', sa.VARCHAR(length=20), nullable=False),
    sa.Column('created_by', sa.INTEGER(), nullable=False),
    sa.Column('created_at', sa.DATETIME(), nullable=False),
    sa.Column('updated_at', sa.DATETIME(), nullable=False),
    sa.ForeignKeyConstraint(['assignment_id'], ['patrol_assignments.id'], ),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('patrol_reports', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_patrol_reports_report_date'), ['report_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_reports_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_reports_assignment_id'), ['assignment_id'], unique=False)

    op.create_table('lk_lp_reports',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('company_id', sa.INTEGER(), nullable=False),
    sa.Column('site_id', sa.INTEGER(), nullable=False),
    sa.Column('incident_type', sa.VARCHAR(length=20), nullable=False),
    sa.Column('incident_number', sa.VARCHAR(length=50), nullable=False),
    sa.Column('incident_date', sa.DATE(), nullable=False),
    sa.Column('reported_by', sa.INTEGER(), nullable=False),
    sa.Column('status', sa.VARCHAR(length=20), server_default=sa.text("'DRAFT'"), nullable=False),
    sa.Column('title', sa.VARCHAR(length=255), nullable=False),
    sa.Column('description', sa.TEXT(), nullable=True),
    sa.Column('location', sa.VARCHAR(length=255), nullable=True),
    sa.Column('evidence_paths', sa.TEXT(), nullable=True),
    sa.Column('police_report_number', sa.VARCHAR(length=100), nullable=True),
    sa.Column('police_station', sa.VARCHAR(length=255), nullable=True),
    sa.Column('perpetrator_name', sa.VARCHAR(length=255), nullable=True),
    sa.Column('perpetrator_details', sa.TEXT(), nullable=True),
    sa.Column('witness_names', sa.TEXT(), nullable=True),
    sa.Column('damage_estimate', sa.VARCHAR(length=100), nullable=True),
    sa.Column('follow_up_required', sa.BOOLEAN(), server_default=sa.text("'0'"), nullable=False),
    sa.Column('created_at', sa.DATETIME(), nullable=False),
    sa.Column('updated_at', sa.DATETIME(), nullable=False),
    sa.ForeignKeyConstraint(['reported_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['site_id'], ['sites.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('incident_number')
    )
    with op.batch_alter_table('lk_lp_reports', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_lk_lp_reports_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_lk_lp_reports_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_lk_lp_reports_incident_type'), ['incident_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_lk_lp_reports_incident_date'), ['incident_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_lk_lp_reports_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_lk_lp_reports_company_id'), ['company_id'], unique=False)

    op.create_table('patrol_assignments',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('schedule_id', sa.INTEGER(), nullable=False),
    sa.Column('user_id', sa.INTEGER(), nullable=False),
    sa.Column('is_lead', sa.BOOLEAN(), server_default=sa.text("'0'"), nullable=False),
    sa.Column('status', sa.VARCHAR(length=20), server_default=sa.text("'ASSIGNED'"), nullable=False),
    sa.Column('assigned_at', sa.DATETIME(), nullable=False),
    sa.Column('started_at', sa.DATETIME(), nullable=True),
    sa.Column('completed_at', sa.DATETIME(), nullable=True),
    sa.Column('notes', sa.TEXT(), nullable=True),
    sa.ForeignKeyConstraint(['schedule_id'], ['patrol_schedules.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('patrol_assignments', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_patrol_assignments_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_assignments_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_assignments_schedule_id'), ['schedule_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_assignments_id'), ['id'], unique=False)

    op.create_table('patrol_schedules',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('company_id', sa.INTEGER(), nullable=False),
    sa.Column('site_id', sa.INTEGER(), nullable=False),
    sa.Column('route_id', sa.INTEGER(), nullable=False),
    sa.Column('scheduled_date', sa.DATE(), nullable=False),
    sa.Column('scheduled_time', sa.VARCHAR(length=8), nullable=False),
    sa.Column('frequency', sa.VARCHAR(length=20), server_default=sa.text("'ONCE'"), nullable=False),
    sa.Column('recurrence_end_date', sa.DATE(), nullable=True),
    sa.Column('notes', sa.TEXT(), nullable=True),
    sa.Column('is_active', sa.BOOLEAN(), server_default=sa.text("'1'"), nullable=False),
    sa.Column('created_by', sa.INTEGER(), nullable=False),
    sa.Column('created_at', sa.DATETIME(), nullable=False),
    sa.Column('updated_at', sa.DATETIME(), nullable=False),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['site_id'], ['sites.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('patrol_schedules', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_patrol_schedules_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_schedules_scheduled_date'), ['scheduled_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_schedules_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_schedules_company_id'), ['company_id'], unique=False)

    op.create_table('audit_schedules',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('company_id', sa.INTEGER(), nullable=False),
    sa.Column('site_id', sa.INTEGER(), nullable=False),
    sa.Column('audit_type', sa.VARCHAR(length=100), nullable=False),
    sa.Column('scheduled_date', sa.DATE(), nullable=False),
    sa.Column('scheduled_time', sa.VARCHAR(length=8), nullable=True),
    sa.Column('auditor_name', sa.VARCHAR(length=255), nullable=True),
    sa.Column('status', sa.VARCHAR(length=20), server_default=sa.text("'SCHEDULED'"), nullable=False),
    sa.Column('notes', sa.TEXT(), nullable=True),
    sa.Column('created_by', sa.INTEGER(), nullable=False),
    sa.Column('created_at', sa.DATETIME(), nullable=False),
    sa.Column('updated_at', sa.DATETIME(), nullable=False),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['site_id'], ['sites.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('audit_schedules', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_audit_schedules_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_schedules_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_schedules_scheduled_date'), ['scheduled_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_schedules_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_schedules_company_id'), ['company_id'], unique=False)

    op.create_table('compliance_checklists',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('company_id', sa.INTEGER(), nullable=False),
    sa.Column('site_id', sa.INTEGER(), nullable=False),
    sa.Column('checklist_name', sa.VARCHAR(length=255), nullable=False),
    sa.Column('category', sa.VARCHAR(length=100), nullable=True),
    sa.Column('description', sa.TEXT(), nullable=True),
    sa.Column('is_active', sa.BOOLEAN(), server_default=sa.text("'1'"), nullable=False),
    sa.Column('created_at', sa.DATETIME(), nullable=False),
    sa.Column('updated_at', sa.DATETIME(), nullable=False),
    sa.ForeignKeyConstraint(['site_id'], ['sites.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('compliance_checklists', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_compliance_checklists_site_id'), ['site_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_compliance_checklists_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_compliance_checklists_company_id'), ['company_id'], unique=False)

    op.create_table('patrol_logs',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('assignment_id', sa.INTEGER(), nullable=False),
    sa.Column('checkpoint_id', sa.INTEGER(), nullable=False),
    sa.Column('scanned_at', sa.DATETIME(), nullable=False),
    sa.Column('latitude', sa.FLOAT(), nullable=True),
    sa.Column('longitude', sa.FLOAT(), nullable=True),
    sa.Column('photo_path', sa.VARCHAR(length=512), nullable=True),
    sa.Column('notes', sa.TEXT(), nullable=True),
    sa.Column('anomaly_detected', sa.BOOLEAN(), server_default=sa.text("'0'"), nullable=False),
    sa.Column('anomaly_details', sa.TEXT(), nullable=True),
    sa.ForeignKeyConstraint(['assignment_id'], ['patrol_assignments.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['checkpoint_id'], ['patrol_checkpoints.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('patrol_logs', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_patrol_logs_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_patrol_logs_assignment_id'), ['assignment_id'], unique=False)

    op.create_table('stplk_reports',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('company_id', sa.INTEGER(), nullable=False),
    sa.Column('site_id', sa.INTEGER(), nullable=False),
    sa.Column('incident_type', sa.VARCHAR(length=20), nullable=False),
    sa.Column('incident_number', sa.VARCHAR(length=50), nullable=False),
    sa.Column('incident_date', sa.DATE(), nullable=False),
    sa.Column('reported_by', sa.INTEGER(), nullable=False),
    sa.Column('status', sa.VARCHAR(length=20), server_default=sa.text("'DRAFT'"), nullable=False),
    sa.Column('title', sa.VARCHAR(length=255), nullable=False),
    sa.Column('description', sa.TEXT(), nullable=True),
    sa.Column('location', sa.VARCHAR(length=255), nullable=True),
    sa.Column('evidence_paths', sa.TEXT(), nullable=True),
    sa.Column('lost_item_description', sa.TEXT(), nullable=False),
    sa.Column('lost_item_value', sa.VARCHAR(length=100), nullable=True),
    sa.Column('lost_date', sa.DATE(), nullable=True),
    sa.Column('lost_location', sa.VARCHAR(length=255), nullable=True),
    sa.Column('owner_name', sa.VARCHAR(length=255), nullable=True),
    sa.Column('owner_contact', sa.VARCHAR(length=100), nullable=True),
    sa.Column('police_report_number', sa.VARCHAR(length=100), nullable=True),
    sa.Column('created_at', sa.DATETIME(), nullable=False),
    sa.Column('updated_at', sa.DATETIME(), nullable=False),
    sa.ForeignKeyConstraint(['reported_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['site_id'], ['sites.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('incident_number')
    )
    with op.batch_alter_table('stplk_reports', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_stplk_reports_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_stplk_reports_company_id'), ['company_id'], unique=False)

    op.create_table('audit_executions',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('audit_schedule_id', sa.INTEGER(), nullable=False),
    sa.Column('checklist_id', sa.INTEGER(), nullable=True),
    sa.Column('compliance_status', sa.VARCHAR(length=20), nullable=False),
    sa.Column('findings', sa.TEXT(), nullable=True),
    sa.Column('corrective_action', sa.TEXT(), nullable=True),
    sa.Column('executed_by', sa.INTEGER(), nullable=False),
    sa.Column('executed_at', sa.DATETIME(), nullable=False),
    sa.Column('created_at', sa.DATETIME(), nullable=False),
    sa.ForeignKeyConstraint(['audit_schedule_id'], ['audit_schedules.id'], ),
    sa.ForeignKeyConstraint(['checklist_id'], ['compliance_checklists.id'], ),
    sa.ForeignKeyConstraint(['executed_by'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('audit_executions', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_audit_executions_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_audit_executions_audit_schedule_id'), ['audit_schedule_id'], unique=False)

    op.create_table('findings_reports',
    sa.Column('id', sa.INTEGER(), nullable=False),
    sa.Column('company_id', sa.INTEGER(), nullable=False),
    sa.Column('site_id', sa.INTEGER(), nullable=False),
    sa.Column('incident_type', sa.VARCHAR(length=20), nullable=False),
    sa.Column('incident_number', sa.VARCHAR(length=50), nullable=False),
    sa.Column('incident_date', sa.DATE(), nullable=False),
    sa.Column('reported_by', sa.INTEGER(), nullable=False),
    sa.Column('status', sa.VARCHAR(length=20), server_default=sa.text("'DRAFT'"), nullable=False),
    sa.Column('title', sa.VARCHAR(length=255), nullable=False),
    sa.Column('description', sa.TEXT(), nullable=True),
    sa.Column('location', sa.VARCHAR(length=255), nullable=True),
    sa.Column('evidence_paths', sa.TEXT(), nullable=True),
    sa.Column('finding_category', sa.VARCHAR(length=100), nullable=True),
    sa.Column('severity_level', sa.VARCHAR(length=20), nullable=True),
    sa.Column('root_cause', sa.TEXT(), nullable=True),
    sa.Column('corrective_action', sa.TEXT(), nullable=True),
    sa.Column('preventive_action', sa.TEXT(), nullable=True),
    sa.Column('responsible_party', sa.VARCHAR(length=255), nullable=True),
    sa.Column('due_date', sa.DATE(), nullable=True),
    sa.Column('resolved_date', sa.DATE(), nullable=True),
    sa.Column('created_at', sa.DATETIME(), nullable=False),
    sa.Column('updated_at', sa.DATETIME(), nullable=False),
    sa.ForeignKeyConstraint(['reported_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['site_id'], ['sites.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('incident_number')
    )
    with op.batch_alter_table('findings_reports', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_findings_reports_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_findings_reports_company_id'), ['company_id'], unique=False)

    with op.batch_alter_table('assets', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_assets_site_id'))
        batch_op.drop_index(batch_op.f('ix_assets_id'))
        batch_op.drop_index(batch_op.f('ix_assets_condition'))
        batch_op.drop_index(batch_op.f('ix_assets_company_id'))
        batch_op.drop_index(batch_op.f('ix_assets_category'))
        batch_op.drop_index(batch_op.f('ix_assets_asset_name'))

    op.drop_table('assets')
    # ### end Alembic commands ###
