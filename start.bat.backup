@echo off
REM Verolux Management System - Start Script for Windows
REM This script starts both backend and frontend servers

setlocal enabledelayedexpansion

echo.
echo ========================================
echo   Verolux Management System - Windows
echo ========================================
echo.

REM Get script directory
set "SCRIPT_DIR=%~dp0"
cd /d "%SCRIPT_DIR%"

REM Check for ngrok flag
set "USE_NGROK=false"
if "%1"=="--ngrok" set "USE_NGROK=true"
if "%1"=="-n" set "USE_NGROK=true"

REM Stop existing processes
echo [*] Stopping existing processes...
for /f "tokens=5" %%a in ('netstat -aon ^| findstr ":8000"') do (
    taskkill /F /PID %%a >nul 2>&1
)
for /f "tokens=5" %%a in ('netstat -aon ^| findstr ":5173"') do (
    taskkill /F /PID %%a >nul 2>&1
)
taskkill /F /IM ngrok.exe >nul 2>&1
timeout /t 2 /nobreak >nul
echo [OK] Processes stopped
echo.

REM Get local IP address
for /f "tokens=2 delims=:" %%a in ('ipconfig ^| findstr /i "IPv4"') do (
    set "IP=%%a"
    set "IP=!IP:~1!"
    goto :ip_found
)
:ip_found
if not defined IP set "IP=192.168.0.160"

REM Start Backend
echo [*] Starting Backend...
cd backend

REM Check if virtual environment exists
if not exist "venv" (
    echo [*] Virtual environment not found. Creating...
    python -m venv venv
    if %errorlevel% neq 0 (
        echo [ERROR] Failed to create virtual environment
        echo         Make sure Python is installed: python --version
        cd ..
        pause
        exit /b 1
    )
    echo [*] Installing dependencies...
    call venv\Scripts\activate.bat
    venv\Scripts\pip.exe install -r requirements.txt
    if %errorlevel% neq 0 (
        echo [ERROR] Failed to install dependencies
        cd ..
        pause
        exit /b 1
    )
    echo [OK] Virtual environment created and dependencies installed
) else (
    echo [*] Virtual environment found
)

REM Check if venv Python exists (Windows or Linux structure)
set "VENV_PYTHON="
set "VENV_ACTIVATE="
set "VENV_TYPE="

if exist "venv\Scripts\python.exe" (
    REM Windows venv structure
    set "VENV_PYTHON=venv\Scripts\python.exe"
    set "VENV_ACTIVATE=venv\Scripts\activate.bat"
    set "VENV_TYPE=Windows"
) else if exist "venv\bin\python" (
    REM Linux/WSL venv structure - need to use WSL or recreate for Windows
    echo [WARNING] Virtual environment is Linux/WSL format
    echo           This venv was created on Linux/WSL system
    echo.
    echo Options:
    echo   1. Recreate venv for Windows (recommended)
    echo   2. Use WSL to run the backend
    echo.
    set /p "RECREATE_VENV=Recreate venv for Windows? (y/n): "
    if /i "!RECREATE_VENV!"=="y" (
        echo [*] Removing old venv...
        rmdir /s /q venv >nul 2>&1
        echo [*] Creating Windows virtual environment...
        python -m venv venv
        if !errorlevel! neq 0 (
            echo [ERROR] Failed to create virtual environment
            echo         Make sure Python is installed: python --version
            cd ..
            pause
            exit /b 1
        )
        echo [*] Installing dependencies...
        call venv\Scripts\activate.bat
        venv\Scripts\pip.exe install -r requirements.txt
        if !errorlevel! neq 0 (
            echo [ERROR] Failed to install dependencies
            cd ..
            pause
            exit /b 1
        )
        echo [OK] Virtual environment recreated for Windows
        set "VENV_PYTHON=venv\Scripts\python.exe"
        set "VENV_ACTIVATE=venv\Scripts\activate.bat"
        set "VENV_TYPE=Windows"
    ) else (
        echo [ERROR] Cannot use Linux venv on Windows without WSL
        echo         Please recreate venv or use WSL
        cd ..
        pause
        exit /b 1
    )
) else (
    echo [ERROR] Virtual environment Python not found
    echo         Recreate venv: rmdir /s /q venv ^&^& python -m venv venv
    cd ..
    pause
    exit /b 1
)

REM Start backend with activated venv
echo [*] Starting backend server...
start "Verolux Backend" cmd /k "cd /d %~dp0backend && %VENV_ACTIVATE% && %VENV_PYTHON% -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000"
cd ..
timeout /t 3 /nobreak >nul

REM Check if backend started
netstat -an | findstr ":8000" >nul
if %errorlevel% equ 0 (
    echo [OK] Backend started on port 8000
) else (
    echo [ERROR] Backend failed to start
    echo Check backend window for error messages
    pause
    exit /b 1
)

REM Start Frontend
echo [*] Starting Frontend...
cd frontend\web

REM Clear Vite cache
echo [*] Clearing Vite cache...
if exist node_modules\.vite rmdir /s /q node_modules\.vite >nul 2>&1
if exist .vite rmdir /s /q .vite >nul 2>&1
echo [OK] Cache cleared
echo.

REM Verify configuration
echo [*] Verifying configuration...

REM Check client.ts
findstr /c:"return \"/api\"" src\api\client.ts >nul 2>&1
if %errorlevel% equ 0 (
    echo [OK] client.ts uses relative /api path
) else (
    echo [WARNING] client.ts may not have the fix applied
)

REM Check vite.config.ts proxy
findstr /c:"proxy:" vite.config.ts >nul 2>&1
if %errorlevel% equ 0 (
    echo [OK] vite.config.ts has proxy configured
) else (
    echo [WARNING] vite.config.ts may not have proxy configured
)

REM Check .env file
if exist .env (
    findstr /c:"VITE_API_BASE_URL.*http://" .env >nul 2>&1
    if !errorlevel! equ 0 (
        echo [WARNING] .env contains hardcoded IP address
        echo           Remove VITE_API_BASE_URL from .env or set it to: VITE_API_BASE_URL=/api
    ) else (
        echo [OK] .env file is OK
    )
) else (
    echo [OK] No .env file (using default relative /api path)
)
echo.

REM Start frontend
start "Verolux Frontend" cmd /c "npx vite --host 0.0.0.0 --port 5173"
cd ..\..
timeout /t 5 /nobreak >nul

REM Check if frontend started
netstat -an | findstr ":5173" >nul
if %errorlevel% equ 0 (
    echo [OK] Frontend started on port 5173
) else (
    echo [ERROR] Frontend failed to start
    echo Check if Node.js is installed and dependencies are installed (npm install)
    pause
    exit /b 1
)

REM Wait for services to be ready
timeout /t 2 /nobreak >nul

REM Verify services
echo.
echo [*] Verifying services...
curl -s --max-time 2 http://localhost:8000/health >nul 2>&1
if %errorlevel% equ 0 (
    echo [OK] Backend is responding
) else (
    echo [WARNING] Backend may not be ready yet
)

REM Check if HTTPS certificates exist
set "FRONTEND_PROTO=http"
if exist "frontend\web\certs\cert.pem" if exist "frontend\web\certs\key.pem" set "FRONTEND_PROTO=https"

curl -s -k --max-time 2 %FRONTEND_PROTO%://localhost:5173 >nul 2>&1
if %errorlevel% equ 0 (
    echo [OK] Frontend is responding
) else (
    echo [WARNING] Frontend may not be ready yet
)
echo.

REM Start ngrok if requested
if "%USE_NGROK%"=="true" (
    echo [*] Starting ngrok tunnel...
    
    REM Check if ngrok is installed
    where ngrok >nul 2>&1
    if %errorlevel% neq 0 (
        if not exist "%SCRIPT_DIR%ngrok.exe" (
            echo [ERROR] ngrok is not installed
            echo         Download from: https://ngrok.com/download
            echo.
            set "USE_NGROK=false"
        ) else (
            set "NGROK_CMD=%SCRIPT_DIR%ngrok.exe"
        )
    ) else (
        set "NGROK_CMD=ngrok"
    )
    
    if "%USE_NGROK%"=="true" (
        REM Kill existing ngrok
        taskkill /F /IM ngrok.exe >nul 2>&1
        timeout /t 2 /nobreak >nul
        
        REM Start ngrok
        if "%FRONTEND_PROTO%"=="https" (
            start "ngrok" cmd /c "%NGROK_CMD% http https://localhost:5173"
        ) else (
            start "ngrok" cmd /c "%NGROK_CMD% http 5173"
        )
        
        timeout /t 8 /nobreak >nul
        echo [OK] ngrok tunnel started
        echo      Waiting for ngrok to initialize...
        
        REM Try to get ngrok URL from API
        set "NGROK_URL="
        for /l %%i in (1,1,10) do (
            timeout /t 1 /nobreak >nul
            REM Use PowerShell to parse JSON from ngrok API
            for /f "delims=" %%j in ('powershell -NoProfile -Command "try { $r = Invoke-RestMethod -Uri 'http://localhost:4040/api/tunnels' -TimeoutSec 2 -ErrorAction Stop; if ($r.tunnels -and $r.tunnels.Count -gt 0) { $r.tunnels[0].public_url } else { '' } } catch { '' }"') do (
                set "NGROK_URL=%%j"
            )
            if defined NGROK_URL goto :ngrok_url_found
        )
        :ngrok_url_found
        
        if defined NGROK_URL (
            echo [OK] Public URL: %NGROK_URL%
        ) else (
            echo [INFO] Check ngrok web interface: http://localhost:4040
            echo        The public URL will be shown there
        )
        echo.
    )
)

REM Display access URLs
echo ========================================
echo   System Started Successfully!
echo ========================================
echo.
echo Access URLs:
echo   Backend:  http://%IP%:8000
echo   Frontend: %FRONTEND_PROTO%://%IP%:5173
echo.
echo From Computer:
echo   Backend:  http://localhost:8000
echo   Frontend: %FRONTEND_PROTO%://localhost:5173
if "%FRONTEND_PROTO%"=="https" (
    echo   [WARNING] Accept security warning (self-signed certificate)
)
echo.
echo From Mobile (same network):
echo   1. Open: %FRONTEND_PROTO%://%IP%:5173
if "%FRONTEND_PROTO%"=="https" (
    echo   2. Accept security warning (Advanced ^> Proceed^)
    echo   3. Login: username='supervisor', password=(empty^)
) else (
    echo   2. Login: username='supervisor', password=(empty^)
)
echo   Or try: security, cleaning, parking
echo.
if "%USE_NGROK%"=="true" (
    echo From Anywhere (via ngrok^):
    if defined NGROK_URL (
        echo   1. Open: %NGROK_URL%
        echo   2. Login: username='supervisor', password=(empty^)
    ) else (
        echo   1. Check ngrok web interface: http://localhost:4040
        echo   2. Use the public URL shown there
        echo   3. Login: username='supervisor', password=(empty^)
    )
    echo.
    echo   ngrok Web Interface: http://localhost:4040
    echo.
)
echo To stop: Run stop.bat or close the command windows
echo.
echo Tip: Run with --ngrok flag to start ngrok tunnel: start.bat --ngrok
echo.

pause

